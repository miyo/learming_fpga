<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:title" content="実験" />
<meta property="og:description" content="実験 HDLのいろいろな記述方法を使って，少し複雑なモジュールの設計に取り組んでみましょう．
はじめに これまでに学んできた内容を利用して，少し応用的な実験に取り組んでみましょう．
ストップウォッチを作ってみよう ここでは，
 アクションボタンを押すとミリ秒毎のカウントアップを開始する カウント中に，アクションボタンを押すとカウントを一時停止する 一時停止中に，アクションボタンを押すとカウントを再開する リセットボタンを押すとカウントを0にクリアする  という機能をもったストップウォッチを作ってみましょう．
残念ながら，ZYBO Z7-20には，7セグメントLEDのような数字を表示する分かりやすい表示器はありませんので，4つのLEDと2つの3色LEDを使って数を表現するとよいでしょう．
次のリストはストップウォッチを実装するためのトップモジュールの例です．3色LEDの明るさを適当に調節するために，PWMモジュールを使って出力を変調しています．PWMモジュールによって，たとえば\verb|&#39;1&#39;|を出力する場合でも，適当なタイミングで&#39;1&rsquo;と&#39;0&rsquo;がまぜられることで明るさを抑えることができます．
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107  library ieee; use ieee." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://miyo.github.io/learning_fpga/docs/book01/experiments/" />
<meta property="article:published_time" content="2019-10-30T19:15:46+09:00" />
<meta property="article:modified_time" content="2019-10-30T19:15:46+09:00" />
<title>実験 | Learning FPGA</title>
<link rel="icon" href="/learning_fpga/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/learning_fpga/book.min.92b28337361d2bcca5e0ffaff5092dda7140e89d9a7a7a4dcc6055fd7d702ace.css" integrity="sha256-krKDNzYdK8yl4P&#43;v9Qkt2nFA6J2aenpNzGBV/X1wKs4=">


<script defer src="/learning_fpga/search.min.e3c12ffe98daefccf377cf8dc1a19401bf4e5d209839c163b48ebdf238712f84.js" integrity="sha256-48Ev/pja78zzd8&#43;NwaGUAb9OXSCYOcFjtI698jhxL4Q="></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://miyo.github.io/learning_fpga/"><span>Learning FPGA</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      <span>RTL編</span>
    

    




  
  <ul>
    
      
        <li>

  <a href="/learning_fpga/docs/book01/introduction/" >
      イントロダクション
  </a>

</li>
      
    
      
        <li>

  <a href="/learning_fpga/docs/book01/languages/" >
      VHDL/Veilog 入門
  </a>

</li>
      
    
      
        <li>

  <a href="/learning_fpga/docs/book01/quickstart/" >
      クイックスタート
  </a>

</li>
      
    
      
        <li>

  <a href="/learning_fpga/docs/book01/simulation/" >
      シミュレーション
  </a>

</li>
      
    
      
        <li>

  <a href="/learning_fpga/docs/book01/basics/" >
      基本実験
  </a>

</li>
      
    
      
        <li>

  <a href="/learning_fpga/docs/book01/experiments/"  class="active">
      実験
  </a>

</li>
      
    
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      <span>高位合成編</span>
    

    




  
  <ul>
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      <span>Intel活用編</span>
    

    




  
  <ul>
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      <span>Xilinx活用編</span>
    

    




  
  <ul>
    
      
        <li>

  <a href="/learning_fpga/docs/book03/ipi/" >
      IP Integrator入門
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
  </ul>
  



  











</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/learning_fpga/svg/menu.svg" alt="Menu" />
  </label>
  <strong>実験</strong>
</header>

      
<article class="markdown"><h1 id="実験">実験</h1>
<p>HDLのいろいろな記述方法を使って，少し複雑なモジュールの設計に取り組んでみましょう．</p>
<h2 id="はじめに">はじめに</h2>
<p>これまでに学んできた内容を利用して，少し応用的な実験に取り組んでみましょう．</p>
<h2 id="ストップウォッチを作ってみよう">ストップウォッチを作ってみよう</h2>
<p>ここでは，</p>
<ul>
<li>アクションボタンを押すとミリ秒毎のカウントアップを開始する</li>
<li>カウント中に，アクションボタンを押すとカウントを一時停止する</li>
<li>一時停止中に，アクションボタンを押すとカウントを再開する</li>
<li>リセットボタンを押すとカウントを0にクリアする</li>
</ul>
<p>という機能をもったストップウォッチを作ってみましょう．</p>
<p>残念ながら，ZYBO Z7-20には，7セグメントLEDのような数字を表示する分かりやすい表示器はありませんので，4つのLEDと2つの3色LEDを使って数を表現するとよいでしょう．</p>
<p>次のリストはストップウォッチを実装するためのトップモジュールの例です．3色LEDの明るさを適当に調節するために，PWMモジュールを使って出力を変調しています．PWMモジュールによって，たとえば\verb|'1'|を出力する場合でも，適当なタイミングで'1&rsquo;と'0&rsquo;がまぜられることで明るさを抑えることができます．</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vhdl" data-lang="vhdl"><span style="color:#66d9ef">library</span> ieee;
<span style="color:#66d9ef">use</span> ieee.std_logic_1164.<span style="color:#66d9ef">all</span>;
<span style="color:#66d9ef">use</span> ieee.numeric_std.<span style="color:#66d9ef">all</span>;

<span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">stopwatch_z7_20</span> <span style="color:#66d9ef">is</span>
  <span style="color:#66d9ef">port</span> (
    CLK <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;

    led6_r <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;
    led6_g <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;
    led6_b <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;
    
    led5_r <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;
    led5_g <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;
    led5_b <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;

    LD <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
    
    btn <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>)
    );
  
<span style="color:#66d9ef">end</span> <span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">stopwatch_z7_20</span>;

<span style="color:#66d9ef">architecture</span> <span style="color:#a6e22e">RTL</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">stopwatch_z7_20</span> <span style="color:#66d9ef">is</span>

  <span style="color:#66d9ef">attribute</span> ASYNC_REG <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>;

  <span style="color:#66d9ef">component</span> <span style="color:#a6e22e">stopwatch</span>
    <span style="color:#66d9ef">generic</span> (
      FREQ_MHz <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">125</span>
      );
    <span style="color:#66d9ef">port</span> (
      clk      <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      reset    <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      action   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      msec_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">9</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
      sec_out  <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">5</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
      min_out  <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">5</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
      hour_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">4</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>)
      );
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">component</span> <span style="color:#a6e22e">stopwatch</span>;

  <span style="color:#66d9ef">component</span> <span style="color:#a6e22e">pwm</span>
    <span style="color:#66d9ef">port</span> (
      clk <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      a   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
      d   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      q   <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>
      );
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">component</span> <span style="color:#a6e22e">pwm</span>;

  <span style="color:#66d9ef">signal</span> btn_d0 <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">signal</span> btn_d1 <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
  
  <span style="color:#66d9ef">attribute</span> ASYNC_REG <span style="color:#66d9ef">of</span> btn_d0, btn_d1 <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;TRUE&#34;</span>;

  <span style="color:#66d9ef">signal</span> msec_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">9</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">signal</span> sec_out  <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">5</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">signal</span> min_out  <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">5</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">signal</span> hour_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">4</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);

  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> msec_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> sec_out  <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> min_out  <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> hour_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;

<span style="color:#66d9ef">begin</span>

  <span style="color:#66d9ef">process</span>(CLK)
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> rising_edge(CLK) <span style="color:#66d9ef">then</span>
      btn_d0 <span style="color:#f92672">&lt;=</span> btn;
      btn_d1 <span style="color:#f92672">&lt;=</span> btn_d0;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

  U<span style="color:#f92672">:</span> stopwatch
    <span style="color:#66d9ef">generic</span> <span style="color:#66d9ef">map</span>(
      FREQ_MHz <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">125</span>
      )
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(
      clk      <span style="color:#f92672">=&gt;</span> CLK,
      reset    <span style="color:#f92672">=&gt;</span> btn_d1(<span style="color:#ae81ff">0</span>),
      action   <span style="color:#f92672">=&gt;</span> btn_d1(<span style="color:#ae81ff">1</span>),
      msec_out <span style="color:#f92672">=&gt;</span> msec_out,
      sec_out  <span style="color:#f92672">=&gt;</span> sec_out,
      min_out  <span style="color:#f92672">=&gt;</span> min_out,
      hour_out <span style="color:#f92672">=&gt;</span> hour_out
      );

  LD <span style="color:#f92672">&lt;=</span> sec_out(<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
  
  PWM0 <span style="color:#f92672">:</span> pwm
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(clk <span style="color:#f92672">=&gt;</span> clk, a <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1100&#34;</span>, d <span style="color:#f92672">=&gt;</span> msec_out(<span style="color:#ae81ff">0</span>), q <span style="color:#f92672">=&gt;</span> led5_r);
  PWM1 <span style="color:#f92672">:</span> pwm
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(clk <span style="color:#f92672">=&gt;</span> clk, a <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1100&#34;</span>, d <span style="color:#f92672">=&gt;</span> msec_out(<span style="color:#ae81ff">1</span>), q <span style="color:#f92672">=&gt;</span> led5_g);
  PWM2 <span style="color:#f92672">:</span> pwm
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(clk <span style="color:#f92672">=&gt;</span> clk, a <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1100&#34;</span>, d <span style="color:#f92672">=&gt;</span> msec_out(<span style="color:#ae81ff">2</span>), q <span style="color:#f92672">=&gt;</span> led5_b);
  PWM3 <span style="color:#f92672">:</span> pwm
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(clk <span style="color:#f92672">=&gt;</span> clk, a <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1100&#34;</span>, d <span style="color:#f92672">=&gt;</span> msec_out(<span style="color:#ae81ff">3</span>), q <span style="color:#f92672">=&gt;</span> led6_r);
  PWM4 <span style="color:#f92672">:</span> pwm
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(clk <span style="color:#f92672">=&gt;</span> clk, a <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1100&#34;</span>, d <span style="color:#f92672">=&gt;</span> msec_out(<span style="color:#ae81ff">4</span>), q <span style="color:#f92672">=&gt;</span> led6_g);
  PWM5 <span style="color:#f92672">:</span> pwm
    <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span>(clk <span style="color:#f92672">=&gt;</span> clk, a <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1100&#34;</span>, d <span style="color:#f92672">=&gt;</span> msec_out(<span style="color:#ae81ff">5</span>), q <span style="color:#f92672">=&gt;</span> led6_b);

<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">RTL</span>;</code></pre></td></tr></table>
</div>
</div>
<p><code>stopwatch</code>モジュールを実装して，完成させてみましょう．</p>
<h2 id="シリアル通信に挑戦してみよう">シリアル通信に挑戦してみよう</h2>
<p>最近のパソコンの外部機器のI/OのほとんどはUSBです．ノート・パソコンは勿論，省スペースのデスクトップ・パソコンにさえ，RS-232-Cのシリアル通信のポートが搭載されなくなってきました．それでも，送信と受信の2本で通信可能なRS-232-Cは，パソコンとFPGAの間やFPGAとFPGAの間でデータを手軽にやりとりする手段として基本的かつ必要不可欠な存在です．</p>
<p>シリアル・ポートのないノート・パソコンでも，市販のUSB-シリアル変換ケーブルやBluetooth-シリアル変換モジュールを使って簡単に接続できます．</p>
<h3 id="シリアル通信のしくみ">シリアル通信のしくみ</h3>
<p>シリアル通信では，受信と送信で独立したポートを持ちます．機器を直結する場合には，お互いの送受信ポートをクロスして結線します(図\ref{fig:serial_comm})．</p>
<figure class="center">
    <img src="../experiments_figures/serial_comm.png"
         alt="図l: シリアル通信の結線"/> <figcaption>
            <p>図l: シリアル通信の結線</p>
        </figcaption>
</figure>

<p>RS-232-Cでは，図\ref{fig:serial_comm_format}のように，8ビットのデータにスタート・ビット（&lsquo;0&rsquo;）とストップ・ビット（&lsquo;1&rsquo;）を付加してデータを通信します．接続した機器同士であらかじめ決めた速度(たとえば19200bpsなど)で信号を送受信することで，共通したクロックを持つことなくデータの送受信ができます．</p>
<figure class="center">
    <img src="../experiments_figures/serial_comm_format.png"
         alt="図2: シリアル通信の信号の伝送方式"/> <figcaption>
            <p>図2: シリアル通信の信号の伝送方式</p>
        </figcaption>
</figure>

<h3 id="送信モジュール">送信モジュール</h3>
<p>決められた速度で信号をパタパタと変化させるだけです．ただし，一般に，シリアル通信の速度は回路の動作クロックに対して，とても遅いので，データを送信している途中に送るべき信号を更新してしまわないようにブロックする仕組みが必要です．VHDLによる実装例を示します．</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vhdl" data-lang="vhdl"><span style="color:#66d9ef">library</span> ieee;
<span style="color:#66d9ef">use</span> ieee.std_logic_1164.<span style="color:#66d9ef">all</span>;
<span style="color:#66d9ef">use</span> ieee.numeric_std.<span style="color:#66d9ef">all</span>;

<span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">uart_tx</span> <span style="color:#66d9ef">is</span>
  <span style="color:#75715e">-- 定数宣言</span>
  <span style="color:#66d9ef">generic</span> (
    sys_clk <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">14000000</span>;             <span style="color:#75715e">--クロック周波数</span>
    rate    <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">9600</span>                  <span style="color:#75715e">--転送レート,単位はbps(ビット毎秒)</span>
    );
  <span style="color:#75715e">-- 入出力ポート宣言</span>
  <span style="color:#66d9ef">port</span> (
    clk   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;                     <span style="color:#75715e">-- クロック</span>
    reset <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;                     <span style="color:#75715e">-- リセット</span>
    wr    <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;                     <span style="color:#75715e">-- 送信要求</span>
    din   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);  <span style="color:#75715e">--送信データ</span>
    dout  <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;                     <span style="color:#75715e">--シリアル出力</span>
    ready <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>                      <span style="color:#75715e">--送信要求を受け付けられるか</span>
    );
<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">uart_tx</span>;

<span style="color:#66d9ef">architecture</span> <span style="color:#a6e22e">rtl</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">uart_tx</span> <span style="color:#66d9ef">is</span>
  <span style="color:#75715e">-- クロック分周モジュールの呼び出しの準備</span>
  <span style="color:#66d9ef">component</span> <span style="color:#a6e22e">clk_div</span> <span style="color:#66d9ef">is</span>
    <span style="color:#66d9ef">port</span> (clk     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
          rst     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
          div     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">15</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
          clk_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>);
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">component</span>;
  <span style="color:#75715e">-- 内部変数定義</span>
  <span style="color:#66d9ef">signal</span> in_din <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);  <span style="color:#75715e">-- 送信データ一時保存用レジスタ</span>
  <span style="color:#66d9ef">signal</span> buf    <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);  <span style="color:#75715e">-- 一時的にしようするバッファ</span>
  <span style="color:#66d9ef">signal</span> load   <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;              <span style="color:#75715e">-- 送信データを読み込んだかどうか</span>
  <span style="color:#66d9ef">signal</span> cbit   <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);  <span style="color:#75715e">-- 送信するビット番号</span>

  <span style="color:#66d9ef">signal</span> run <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;               <span style="color:#75715e">-- 送信状態にあるかどうか</span>

  <span style="color:#66d9ef">signal</span> tx_en   <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span>; <span style="color:#75715e">-- 送信用クロック</span>
  <span style="color:#66d9ef">signal</span> tx_en_d <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>; <span style="color:#75715e">-- 送信用クロックの立ち上がり検出用</span>
  
  <span style="color:#66d9ef">signal</span> tx_div <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">15</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>); <span style="color:#75715e">-- クロック分周の倍率</span>

  <span style="color:#66d9ef">signal</span> status <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>); <span style="color:#75715e">-- 状態遷移用レジスタ</span>

<span style="color:#66d9ef">begin</span>

  <span style="color:#75715e">-- クロック分周モジュールの呼び出し</span>
  <span style="color:#75715e">-- clk_divの入出力ポートにこのモジュールの内部変数を接続</span>
  tx_div <span style="color:#f92672">&lt;=</span> <span style="color:#66d9ef">std_logic_vector</span>(to_unsigned((sys_clk <span style="color:#f92672">/</span> rate) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">16</span>));
  U0 <span style="color:#f92672">:</span> clk_div <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span> (clk<span style="color:#f92672">=&gt;</span>clk, rst<span style="color:#f92672">=&gt;</span>reset, div<span style="color:#f92672">=&gt;</span>tx_div, clk_out<span style="color:#f92672">=&gt;</span>tx_en);

  <span style="color:#75715e">-- readyへの代入, 常時値を更新している</span>
  ready  <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">when</span> (wr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">and</span> run <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">and</span> load <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;0&#39;</span>;

  <span style="color:#66d9ef">process</span>(clk) <span style="color:#75715e">--変化を監視する信号を記述する, この場合クロック</span>
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> rising_edge(clk) <span style="color:#66d9ef">then</span>  <span style="color:#75715e">--クロックの立ち上がり時の動作</span>
      <span style="color:#66d9ef">if</span> reset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>                 <span style="color:#75715e">--リセット時の動作, 初期値の設定</span>
        load <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
      <span style="color:#66d9ef">else</span>
        <span style="color:#66d9ef">if</span>(wr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">and</span> run <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#66d9ef">then</span>    <span style="color:#75715e">--送信要求があり，かつ送信中でない場合</span>
          load   <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;                   <span style="color:#75715e">--データを取り込んだフラグを立てる</span>
          in_din <span style="color:#f92672">&lt;=</span> din;                   <span style="color:#75715e">--一時保存用レジスタに値を格納</span>
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        <span style="color:#66d9ef">if</span>(load <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">and</span> run <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>) <span style="color:#66d9ef">then</span>  <span style="color:#75715e">--送信中で，かつデータを取り込んだ</span>
                                           <span style="color:#75715e">--ことを示すフラグが立っている場合</span>
          load <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;                     <span style="color:#75715e">--データを取り込んだフラグを下げる</span>
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

  <span style="color:#66d9ef">process</span>(clk)                            <span style="color:#75715e">--変化を監視する信号(クロック)</span>
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> rising_edge(clk) <span style="color:#66d9ef">then</span>
      <span style="color:#66d9ef">if</span> reset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>                 <span style="color:#75715e">--リセット時の動作, 初期値の設定</span>
        dout    <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
        cbit    <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        status  <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        run     <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
        tx_en_d <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
      <span style="color:#66d9ef">else</span>
        tx_en_d <span style="color:#f92672">&lt;=</span> tx_en;
        <span style="color:#66d9ef">if</span> tx_en <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">and</span> tx_en_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">then</span> <span style="color:#75715e">-- tx_enの立ち上がりで動作</span>
          <span style="color:#66d9ef">case</span> to_integer(status) <span style="color:#66d9ef">is</span>        <span style="color:#75715e">--statusの値に応じて動作が異なる</span>
            <span style="color:#66d9ef">when</span> <span style="color:#ae81ff">0</span>          <span style="color:#f92672">=&gt;</span>              <span style="color:#75715e">--初期状態</span>
              cbit <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);        <span style="color:#75715e">--カウンタをクリア</span>
              <span style="color:#66d9ef">if</span> load <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>              <span style="color:#75715e">-- データを取り込んでいる場合</span>
                dout   <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;                <span style="color:#75715e">-- スタートビット0を出力</span>
                status <span style="color:#f92672">&lt;=</span> status <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;         <span style="color:#75715e">-- 次の状態へ</span>
                buf    <span style="color:#f92672">&lt;=</span> in_din;             <span style="color:#75715e">-- 送信データを一時バッファに退避</span>
                run    <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;                <span style="color:#75715e">-- 送信中の状態へ遷移</span>
              <span style="color:#66d9ef">else</span>                            <span style="color:#75715e">--なにもしない状態へ遷移</span>
                dout <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
                run  <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;                  <span style="color:#75715e">--送信要求受付可能状態へ</span>
              <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
            <span style="color:#66d9ef">when</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=&gt;</span>                         <span style="color:#75715e">--データをLSBから順番に送信</span>
              cbit <span style="color:#f92672">&lt;=</span> cbit <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;               <span style="color:#75715e">-- カウンタをインクリメント</span>
              dout <span style="color:#f92672">&lt;=</span> buf(to_integer(cbit));  <span style="color:#75715e">--一時バッファのcbit目を取出して出力</span>
              <span style="color:#66d9ef">if</span>(to_integer(cbit) <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>) <span style="color:#66d9ef">then</span>   <span style="color:#75715e">-- データの8ビット目を送信したら,</span>
                                              <span style="color:#75715e">-- ストップビットを送る状態へ遷移</span>
                status <span style="color:#f92672">&lt;=</span> status <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
              <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
            <span style="color:#66d9ef">when</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">=&gt;</span>                         <span style="color:#75715e">-- ストップビットを送信</span>
              dout   <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;                  <span style="color:#75715e">--ストップビット1</span>
              status <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);      <span style="color:#75715e">--初期状態へ</span>
            <span style="color:#66d9ef">when</span> <span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span>                    <span style="color:#75715e">--その他の状態の場合</span>
              status <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);      <span style="color:#75715e">-- 初期状態へ遷移</span>
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">case</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">rtl</span>;</code></pre></td></tr></table>
</div>
</div>
<p>内部で利用している<code>clk_div</code>の実装は次の通りです．</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vhdl" data-lang="vhdl"><span style="color:#66d9ef">library</span> ieee;
<span style="color:#66d9ef">use</span> ieee.std_logic_1164.<span style="color:#66d9ef">ALL</span>;
<span style="color:#66d9ef">use</span> ieee.numeric_std.<span style="color:#66d9ef">all</span>;

<span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">clk_div</span> <span style="color:#66d9ef">is</span>
  <span style="color:#66d9ef">port</span>(
    clk     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
    rst     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
    div     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">15</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
    clk_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>
    );
<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">clk_div</span>;

<span style="color:#66d9ef">architecture</span> <span style="color:#a6e22e">RTL</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">clk_div</span> <span style="color:#66d9ef">is</span>

  <span style="color:#66d9ef">signal</span> counter <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">15</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);

<span style="color:#66d9ef">begin</span>

  <span style="color:#66d9ef">process</span>(clk)
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span>(clk<span style="color:#a6e22e">&#39;event</span> <span style="color:#66d9ef">and</span> clk <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>) <span style="color:#66d9ef">then</span>
      <span style="color:#66d9ef">if</span>(rst <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>) <span style="color:#66d9ef">then</span>
        counter <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
      <span style="color:#66d9ef">elsif</span> (counter <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsigned</span>(div)) <span style="color:#66d9ef">then</span>
        counter <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        clk_out <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
      <span style="color:#66d9ef">else</span>
        counter <span style="color:#f92672">&lt;=</span> counter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        clk_out  <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>; 
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">RTL</span>;</code></pre></td></tr></table>
</div>
</div>
<p><code>clk_div</code>モジュールで生成した，シリアル送信用の信号にあわせて，送信すべきデータを1bitずつ出力します．
また，出力中はready信号を<code>'0'</code>にすることで，送信モジュールが動作中であることを上位のモジュールに伝えられるようになっています．</p>
<p>このモジュールの動作をシミュレーションで確認してみましょう．</p>
<h3 id="受信モジュール">受信モジュール</h3>
<p>受信モジュールは送信モジュールに比べて少し複雑になります．送信側は自分のタイミングで信号を送ればいいのに対し，受信側ではスタート・ビットを頼りにデータの開始を検出し，以降の信号を正しい間隔でビットに分割しなければならないからです．また，データにはノイズが乗っている可能性もあるので，データを正しく取得する仕組みも必要です．
VHDLとVerilog HDLによる実装の例が次のリストです．この例では，通信速度の16倍のクロックでデータをサンプリング（一定間隔で読み込む）することで，データを受信しています．</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vhdl" data-lang="vhdl"><span style="color:#66d9ef">library</span> ieee;
<span style="color:#66d9ef">use</span> ieee.std_logic_1164.<span style="color:#66d9ef">all</span>;
<span style="color:#66d9ef">use</span> ieee.numeric_std.<span style="color:#66d9ef">all</span>;

<span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">uart_rx</span> <span style="color:#66d9ef">is</span>
  <span style="color:#75715e">-- 定数宣言</span>
  <span style="color:#66d9ef">generic</span>(
    sys_clk <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">14000000</span>;            <span style="color:#75715e">--クロック周波数</span>
    rate    <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">9600</span>                 <span style="color:#75715e">--転送レート,単位はbps(ビット毎秒)</span>
    );
  <span style="color:#75715e">-- 入出力ポート宣言</span>
  <span style="color:#66d9ef">port</span>(
    clk   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;                    <span style="color:#75715e">-- クロック</span>
    reset <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;                    <span style="color:#75715e">-- リセット</span>
    din   <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;                    <span style="color:#75715e">-- シリアル入力</span>
    rd    <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;                    <span style="color:#75715e">-- 受信完了を示す</span>
    dout  <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>)  <span style="color:#75715e">-- 受信データ</span>
    );
<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">uart_rx</span>;

<span style="color:#66d9ef">architecture</span> <span style="color:#a6e22e">rtl</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">uart_rx</span> <span style="color:#66d9ef">is</span>

  <span style="color:#75715e">--クロック分周モジュールのインスタンス生成の準備</span>
  <span style="color:#66d9ef">component</span> <span style="color:#a6e22e">clk_div</span> <span style="color:#66d9ef">is</span>
    <span style="color:#66d9ef">port</span>(
      clk     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      rst     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
      div     <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">15</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
      clk_out <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>
      );
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">component</span>;
  <span style="color:#75715e">--内部変数宣言</span>
  <span style="color:#66d9ef">signal</span> buf       <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);   <span style="color:#75715e">--受信データ系列の一時保存用</span>
  <span style="color:#66d9ef">signal</span> receiving <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span>;         <span style="color:#75715e">--受信しているかどうか</span>
  <span style="color:#66d9ef">signal</span> cbit      <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">range</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">to</span> <span style="color:#ae81ff">150</span>; <span style="color:#75715e">-- データの取り込みタイミング用カウンタ</span>
  <span style="color:#66d9ef">signal</span> rx_en     <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span>;         <span style="color:#75715e">--受信用クロック</span>
  <span style="color:#66d9ef">signal</span> rx_en_d   <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;  <span style="color:#75715e">--受信用クロック立ち上がり判定用レジスタ</span>
  <span style="color:#66d9ef">signal</span> rx_div    <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(<span style="color:#ae81ff">15</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);  <span style="color:#75715e">--クロック分周の倍率</span>

<span style="color:#66d9ef">begin</span>
  <span style="color:#75715e">--クロック分周モジュールのインスタンス生成</span>
  <span style="color:#75715e">--受信側は送信側の16倍の速度で値を取り込み処理を行う</span>
  rx_div <span style="color:#f92672">&lt;=</span> <span style="color:#66d9ef">std_logic_vector</span>(to_unsigned(((sys_clk <span style="color:#f92672">/</span> rate) <span style="color:#f92672">/</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">16</span>));
  U0 <span style="color:#f92672">:</span> clk_div <span style="color:#66d9ef">port</span> <span style="color:#66d9ef">map</span> (clk<span style="color:#f92672">=&gt;</span>clk, rst<span style="color:#f92672">=&gt;</span>reset, div<span style="color:#f92672">=&gt;</span>rx_div, clk_out<span style="color:#f92672">=&gt;</span>rx_en);
  
  <span style="color:#66d9ef">process</span>(clk)                          <span style="color:#75715e">--変化を監視する信号を記述,この場合クロック</span>
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> rising_edge(clk) <span style="color:#66d9ef">then</span>
      <span style="color:#66d9ef">if</span> reset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>               <span style="color:#75715e">--リセット時の動作, 初期値の設定</span>
        receiving <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
        cbit      <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        buf       <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        dout      <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        rd        <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
        rx_en_d   <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
      <span style="color:#66d9ef">else</span>
        rx_en_d <span style="color:#f92672">&lt;=</span> rx_en;
        <span style="color:#66d9ef">if</span> rx_en <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">and</span> rx_en_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">then</span>   <span style="color:#75715e">--受信用クロック立ち上がり時の動作</span>
          <span style="color:#66d9ef">if</span> receiving <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">then</span>       <span style="color:#75715e">--受信中でない場合</span>
            <span style="color:#66d9ef">if</span> din <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">then</span>           <span style="color:#75715e">--スタートビット0を受信したら</span>
              rd <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;                <span style="color:#75715e">--受信完了のフラグをさげる</span>
              receiving <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
          <span style="color:#66d9ef">else</span>                          <span style="color:#75715e">--受信中の場合</span>
            <span style="color:#66d9ef">case</span> cbit <span style="color:#66d9ef">is</span>                <span style="color:#75715e">--カウンタに合わせてデータをラッチ</span>
              <span style="color:#66d9ef">when</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">=&gt;</span>                 <span style="color:#75715e">-- スタートビットのチェック</span>
                <span style="color:#66d9ef">if</span> din <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>       <span style="color:#75715e">-- スタートビットが中途半端．入力をキャンセル</span>
                  receiving <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
                  cbit      <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">else</span>
                  cbit <span style="color:#f92672">&lt;=</span> cbit <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
              <span style="color:#66d9ef">when</span> <span style="color:#ae81ff">22</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">38</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">54</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">70</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">86</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">102</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">118</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">134</span> <span style="color:#f92672">=&gt;</span>  <span style="color:#75715e">--data</span>
                cbit <span style="color:#f92672">&lt;=</span> cbit <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                buf  <span style="color:#f92672">&lt;=</span> din <span style="color:#f92672">&amp;</span> buf(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">1</span>);  <span style="color:#75715e">-- 新しい入力と受信済みデータを連結</span>
              <span style="color:#66d9ef">when</span> <span style="color:#ae81ff">150</span> <span style="color:#f92672">=&gt;</span>               <span style="color:#75715e">--stop</span>
                rd        <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
                dout      <span style="color:#f92672">&lt;=</span> buf;
                receiving <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;       <span style="color:#75715e">-- 受信完了</span>
                cbit      <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
              <span style="color:#66d9ef">when</span> <span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span>
                cbit <span style="color:#f92672">&lt;=</span> cbit <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">case</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">RTL</span>;</code></pre></td></tr></table>
</div>
</div>
<p>通信速度の16倍でデータをサンプリングしているので，スタート・ビットは16サイクル分が取得できるはずです．スタートビットのはじまりと思われる'0&rsquo;というデータを確認してから6サイクル目のデータをもう一度取得し，そのデータがやっぱり'0&rsquo;であれば，データ送信が開始されたと解釈します（ソース・コード中の状態1）．データが送信されていることを確認した後は，16サイクル毎にデータを取得します（ソース・コード中の状態2）．8bit分データを取得したら完了です．</p>
<p>送信モジュールと同じように，テストベンチを書いてシミュレーションで動作を確認してみましょう．</p>
<h3 id="実機で動作確認">実機で動作確認</h3>
<p>シリアル通信を実機で動作確認してみましょう．入出力にPMODコネクタJEの1ピンと7ピンを割当て，物理的に両者をジャンパピンで接続すれば，通信ができるはずです．動作をILAを使って確認してみましょう．{\bf 注意: PMODコネクタの6ピンと12ピンは3.3V，5ピンと11ピンはGNDです．間違って6ピンと5ピンなどのように3.3VとGNDを直結しないようにしましょう．}</p>
<figure class="center">
    <img src="../experiments_figures/IMG_0007.JPG"
         alt="図3: PMODコネクタのJEの1ピンと7ピンをジャンパケーブルで接続した様子"/> <figcaption>
            <p>図3: PMODコネクタのJEの1ピンと7ピンをジャンパケーブルで接続した様子</p>
        </figcaption>
</figure>

<h2 id="音声信号を観測してみよう">音声信号を観測してみよう</h2>
<p>ZYBO Z7-20には音声入出力用のジャックが備わっています．これを利用すると外部からの音声信号を取り込みFPGAで処理することができます．信号は，SSM2603というICでA/D変換されます．SSM2603とFPGAはI2Sで音声データをやりとりすることができます．</p>
<p>SSM2603とやりとりするI2S信号は図\ref{fig:ssm2603_protocol}の通りです．</p>
<figure class="center">
    <img src="../experiments_figures/zybo-z7-audio.png"
         alt="図4: SSM2603との通信インターフェース"/> <figcaption>
            <p>図4: SSM2603との通信インターフェース</p>
        </figcaption>
</figure>

<p>これを送受信するモジュールを実装して音声信号の入出力をやってみましょう．
でてくる信号が少し増えて複雑にみえるかもしれませんが，方針はRS-232-Cの送受信と同じです．</p>
<h3 id="i2sの送信">I2Sの送信</h3>
<p>次のリストは，I2Sの送信モジュールの実装例です．シミュレーションによって，信号が図\ref{fig:ssm2603_protocol}に示したように出力されることを確認してみましょう．</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vhdl" data-lang="vhdl"><span style="color:#66d9ef">library</span> ieee;

<span style="color:#66d9ef">use</span> ieee.std_logic_1164.<span style="color:#66d9ef">all</span>;
<span style="color:#66d9ef">use</span> ieee.numeric_std.<span style="color:#66d9ef">all</span>;

<span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">i2s_encoder</span> <span style="color:#66d9ef">is</span>
  <span style="color:#66d9ef">generic</span> (
    WIDTH <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">24</span>
    );
  <span style="color:#66d9ef">port</span> (
    CLK <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic</span>; <span style="color:#75715e">-- BCLK 4x</span>

    BCLK <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
    LRC  <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span>  <span style="color:#66d9ef">std_logic</span>;
    DAT  <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;

    LIN <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
    RIN <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>)
    );
<span style="color:#66d9ef">end</span> <span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">i2s_encoder</span>;

<span style="color:#66d9ef">architecture</span> <span style="color:#a6e22e">RTL</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">i2s_encoder</span> <span style="color:#66d9ef">is</span>

  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>;

  <span style="color:#66d9ef">signal</span> left_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  <span style="color:#66d9ef">signal</span> left_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);

  <span style="color:#66d9ef">signal</span> right_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  <span style="color:#66d9ef">signal</span> right_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">7</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  
  <span style="color:#66d9ef">signal</span> lrc_d <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
  <span style="color:#66d9ef">signal</span> bclk_d <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;

  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> left_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> left_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> right_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> right_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;

<span style="color:#66d9ef">begin</span>

  <span style="color:#66d9ef">process</span>(CLK)
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> rising_edge(CLK) <span style="color:#66d9ef">then</span>
      
      lrc_d  <span style="color:#f92672">&lt;=</span> LRC;
      bclk_d <span style="color:#f92672">&lt;=</span> BCLK;
      
      <span style="color:#66d9ef">if</span> lrc_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">and</span> LRC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">then</span>
        left_cnt  <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        left_data <span style="color:#f92672">&lt;=</span> LIN;
      <span style="color:#66d9ef">else</span>
        <span style="color:#66d9ef">if</span> left_cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
          left_cnt  <span style="color:#f92672">&lt;=</span> left_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
          <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">&lt;=</span> left_cnt <span style="color:#66d9ef">then</span>
            DAT        <span style="color:#f92672">&lt;=</span> left_data(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
            <span style="color:#66d9ef">if</span> left_cnt(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#66d9ef">then</span>
              left_data <span style="color:#f92672">&lt;=</span> left_data(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> <span style="color:#e6db74">&#39;0&#39;</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      
      <span style="color:#66d9ef">if</span> lrc_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">and</span> LRC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>
        right_cnt  <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        right_data <span style="color:#f92672">&lt;=</span> RIN;
      <span style="color:#66d9ef">else</span>
        <span style="color:#66d9ef">if</span> right_cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
          right_cnt  <span style="color:#f92672">&lt;=</span> right_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
          <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">&lt;=</span> right_cnt <span style="color:#66d9ef">then</span>
            DAT        <span style="color:#f92672">&lt;=</span> right_data(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
            <span style="color:#66d9ef">if</span> right_cnt(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#66d9ef">then</span>
              right_data <span style="color:#f92672">&lt;=</span> right_data(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> <span style="color:#e6db74">&#39;0&#39;</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">RTL</span>;</code></pre></td></tr></table>
</div>
</div>
<h3 id="i2sの受信">I2Sの受信</h3>
<p>次は受信モジュールです．送信モジュールと組み合わせてシミュレーションすることで，入力した音声信号をI2Sフォーマットに変換し，それが復号される様を観測することができます．</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">97
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vhdl" data-lang="vhdl"><span style="color:#66d9ef">library</span> ieee;

<span style="color:#66d9ef">use</span> ieee.std_logic_1164.<span style="color:#66d9ef">all</span>;
<span style="color:#66d9ef">use</span> ieee.numeric_std.<span style="color:#66d9ef">all</span>;

<span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">i2s_decoder</span> <span style="color:#66d9ef">is</span>
  <span style="color:#66d9ef">generic</span> (
    WIDTH <span style="color:#f92672">:</span> <span style="color:#66d9ef">integer</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">24</span>
    );
  <span style="color:#66d9ef">port</span> (
    CLK <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic</span>;
    
    BCLK <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic</span>;
    LRC  <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic</span>;
    DAT  <span style="color:#f92672">:</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">std_logic</span>;

    LOUT <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
    ROUT <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>);
    LOUT_VALID <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>;
    ROUT_VALID <span style="color:#f92672">:</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">std_logic</span>
    );
<span style="color:#66d9ef">end</span> <span style="color:#66d9ef">entity</span> <span style="color:#a6e22e">i2s_decoder</span>;

<span style="color:#66d9ef">architecture</span> <span style="color:#a6e22e">RTL</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">i2s_decoder</span> <span style="color:#66d9ef">is</span>

  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>;

  <span style="color:#66d9ef">signal</span> left_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  <span style="color:#66d9ef">signal</span> left_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">5</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  <span style="color:#66d9ef">signal</span> left_valid <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;

  <span style="color:#66d9ef">signal</span> right_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic_vector</span>(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  <span style="color:#66d9ef">signal</span> right_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">unsigned</span>(<span style="color:#ae81ff">5</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">:=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
  <span style="color:#66d9ef">signal</span> right_valid <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
  
  <span style="color:#66d9ef">signal</span> lrc_d <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;

  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> left_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> left_valid <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> left_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> right_data  <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> right_valid <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;
  <span style="color:#66d9ef">attribute</span> mark_debug <span style="color:#66d9ef">of</span> right_cnt   <span style="color:#f92672">:</span> <span style="color:#66d9ef">signal</span> <span style="color:#66d9ef">is</span> <span style="color:#e6db74">&#34;true&#34;</span>;

  <span style="color:#66d9ef">signal</span> bclk_d <span style="color:#f92672">:</span> <span style="color:#66d9ef">std_logic</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#39;0&#39;</span>;

<span style="color:#66d9ef">begin</span>

  LOUT_VALID <span style="color:#f92672">&lt;=</span> left_valid;
  ROUT_VALID <span style="color:#f92672">&lt;=</span> right_valid;
  
  LOUT <span style="color:#f92672">&lt;=</span> left_data;
  ROUT <span style="color:#f92672">&lt;=</span> right_data;

  <span style="color:#66d9ef">process</span>(CLK)
  <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> rising_edge(CLK) <span style="color:#66d9ef">then</span>
      bclk_d <span style="color:#f92672">&lt;=</span> BCLK;

      <span style="color:#66d9ef">if</span> bclk_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">and</span> BCLK <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>
        
        left_data  <span style="color:#f92672">&lt;=</span> left_data(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> DAT;
        right_data <span style="color:#f92672">&lt;=</span> right_data(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">downto</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> DAT;

        lrc_d <span style="color:#f92672">&lt;=</span> LRC;
        
        <span style="color:#66d9ef">if</span> lrc_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">and</span> LRC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">then</span>
          left_cnt <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        <span style="color:#66d9ef">else</span>
          <span style="color:#66d9ef">if</span> left_cnt <span style="color:#f92672">=</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
            left_valid <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
          <span style="color:#66d9ef">else</span>
            left_valid <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
          <span style="color:#66d9ef">if</span> left_cnt <span style="color:#f92672">&lt;=</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
            left_cnt <span style="color:#f92672">&lt;=</span> left_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        
        <span style="color:#66d9ef">if</span> lrc_d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">and</span> LRC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">then</span>
          right_cnt <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">others</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>);
        <span style="color:#66d9ef">else</span>
          <span style="color:#66d9ef">if</span> right_cnt <span style="color:#f92672">=</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
            right_valid <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
          <span style="color:#66d9ef">else</span>
            right_valid <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
          <span style="color:#66d9ef">if</span> right_cnt <span style="color:#f92672">&lt;=</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
            right_cnt <span style="color:#f92672">&lt;=</span> right_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
          <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
      <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
  <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">process</span>;

<span style="color:#66d9ef">end</span> <span style="color:#a6e22e">RTL</span>;</code></pre></td></tr></table>
</div>
</div>
<h2 id="発展">発展</h2>
<p>紹介したアプリケーション実験を応用して，次のような課題に挑戦してみましょう．</p>
<ol>
<li>ストップウォッチモジュールを改造して，カウントダウンできるようにしてみましょう．</li>
<li>いろいろな通信速度でRS-232-C通信を試してみましょう．</li>
<li>音声入出力ができるようになったので，たとえば，規定値より大きな値がきたときだけ音声を出力する，平滑化フィルタで音を滑らかにする，などが簡単には考えられるでしょう．</li>
</ol>
</article>

      

      
    </div>

    
  

  <aside class="book-toc levels-6 fixed">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#ストップウォッチを作ってみよう">ストップウォッチを作ってみよう</a></li>
    <li><a href="#シリアル通信に挑戦してみよう">シリアル通信に挑戦してみよう</a>
      <ul>
        <li><a href="#シリアル通信のしくみ">シリアル通信のしくみ</a></li>
        <li><a href="#送信モジュール">送信モジュール</a></li>
        <li><a href="#受信モジュール">受信モジュール</a></li>
        <li><a href="#実機で動作確認">実機で動作確認</a></li>
      </ul>
    </li>
    <li><a href="#音声信号を観測してみよう">音声信号を観測してみよう</a>
      <ul>
        <li><a href="#i2sの送信">I2Sの送信</a></li>
        <li><a href="#i2sの受信">I2Sの受信</a></li>
      </ul>
    </li>
    <li><a href="#発展">発展</a></li>
  </ul>
</nav>
  </aside>



  </main>

  
</body>

</html>
